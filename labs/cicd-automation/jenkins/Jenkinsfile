def  appName = 'web-ui'
def  feSvcName = "${appName}"
def  ACRNAME = 'tugboatlabs'
def  imageTag = "tugboatlabs.azurecr.io/${appName}:${env.BRANCH_NAME}.${env.BUILD_NUMBER}"

pipeline {
  agent {
    kubernetes {
      label 'sample-app'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
metadata:
labels:
  component: ci
spec:
  # Use service account that can deploy to all namespaces
  serviceAccountName: jenkins
  containers:
  - name: helm
    image: lachlanevenson/k8s-helm:latest
    command:
    - cat
    tty: true
  - name: azurecli
    image: microsoft/azure-cli:latest
    command:
    - cat
    tty: true
  - name: kubectl
    image: lachlanevenson/k8s-kubectl:latest
    command:
    - cat
    tty: true
"""
}
  }
  stages {

    
    stage('Build Container and Push to Registry') {
      steps {
        container('azurecli') {
        withCredentials([azureServicePrincipal('azure-cli')]) {
            sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
            sh 'az account set -s $AZURE_SUBSCRIPTION_ID'
            sh("az acr build -t ${imageTag} -r ${ACRNAME} .")
        }
      }
     }
    }
    
    stage('Deploy To Production') {
      // Production branch
      steps{
        container('helm') {
        // Change deployed image in canary to the one we just built
          sh("sed -i.bak 's#gcr.io/cloud-solutions-images/gceme:1.0.0#${imageTag}#' ./k8s/production/*.yaml")
          sh("helm install -f ../../../../../charts/web-ui .")
          sh("echo http://`kubectl --namespace=production get service/${feSvcName} -o jsonpath='{.status.loadBalancer.ingress[0].ip}'` > ${feSvcName}")
        }
      }
    }
  }
}